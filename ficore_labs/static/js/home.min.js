document.addEventListener('DOMContentLoaded',function(){document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(tooltipTriggerEl=>{new bootstrap.Tooltip(tooltipTriggerEl);});document.querySelectorAll('.bi').forEach(icon=>{if(!icon.className.includes('bi-')){console.warn('Invalid or missing Bootstrap Icon class:',icon.className);}});const topNav=document.querySelector('.fintech-top-header');const bottomNav=document.querySelector('.bottom-nav');if(topNav&&bottomNav){const topNavItems=topNav.querySelectorAll('.nav-item');if(topNavItems.length>0){console.warn('Unexpected navigation items in top-header:',topNavItems);}}{%if current_user.is_authenticated%}loadFinancialSummary();loadRecentActivity();{%endif%}});{%if current_user.is_authenticated%}let amountsVisible=true;let allActivities=[];let isShowingAllActivities=false;const translations={just_now:'{{t("general_just_now",default="Just now")|e}}',minutes_ago:'{{t("general_minutes_ago",default="m ago")|e}}',hours_ago:'{{t("general_hours_ago",default="h ago")|e}}',days_ago:'{{t("general_days_ago",default="d ago")|e}}',owed_to_you:'{{t("general_owed_to_you",default="Owed to you")|e}}',you_owe:'{{t("general_you_owe",default="You owe")|e}}',balanced:'{{t("general_balanced",default="Balanced")|e}}',no_recent_activity:'{{t("general_no_recent_activity",default="No recent activity")|e}}',start_by_adding_debt:'{{t("general_start_adding",default="Start by adding a debt or transaction")|e}}',view_all:'{{t("general_view_all",default="View All")|e}}',view_less:'{{t("general_view_less",default="View Less")|e}}'};function loadFinancialSummary(){Promise.all([fetch('{{url_for("business.debt_summary")|e}}',{credentials:'include'}).then(r=>{if(!r.ok)throw new Error('Debt summary fetch failed:'+r.status);return r.json();}).catch(error=>{console.error('Debt summary fetch error:',error);return{totalIOwe:0,totalIAmOwed:0};}),fetch('{{url_for("business.cashflow_summary")|e}}',{credentials:'include'}).then(r=>{if(!r.ok)throw new Error('Cashflow summary fetch failed:'+r.status);return r.json();}).catch(error=>{console.error('Cashflow summary fetch error:',error);return null;})]).then(([debtData,cashflowData])=>{console.log('Debt summary data:',debtData);console.log('Cashflow summary data:',cashflowData);updateDebtSummary(debtData);if(cashflowData&&'totalPayments' in cashflowData&&!isNaN(cashflowData.totalPayments)){updateCashflowSummary(cashflowData);}else{console.warn('Skipping cashflow update due to invalid or missing data');}}).catch(error=>{console.error('Error loading financial data:',error);});}function loadRecentActivity(){fetch('{{url_for("business.recent_activity")|e}}',{credentials:'include'}).then(response=>{if(!response.ok)throw new Error('Recent activity fetch failed:'+response.status);return response.json();}).then(activities=>{allActivities=activities;renderRecentActivities(isShowingAllActivities?activities:activities.slice(0,2));updateViewAllLink();}).catch(error=>{console.error('Error loading recent activity:',error);renderRecentActivities([]);});}function renderRecentActivities(activities){const activityList=document.getElementById('recentActivityList');if(activities&&activities.length>0){activityList.innerHTML=activities.map(activity=>`<div class="recent-activity-card"><div class="activity-item"><div class="activity-icon"><i class="bi ${activity.icon||getActivityIcon(activity.type)}${getActivityColor(activity.type)}"></i></div><div class="activity-content"><div class="activity-description fw-semibold">${activity.description}</div><div class="activity-time text-muted">${formatTimeAgo(activity.timestamp)}</div></div>${activity.amount?`<div class="activity-amount text-nowrap ms-2 fw-bold">${format_currency(activity.amount)}</div>`:''}</div></div>`).join('');}else{activityList.innerHTML=`<div class="recent-activity-card"><div class="activity-item"><div class="activity-icon"><i class="bi bi-info-circle text-muted"></i></div><div class="activity-content"><div class="activity-description fw-semibold">${translations.no_recent_activity}</div><div class="activity-time text-muted">${translations.start_by_adding_debt}</div></div></div></div>`;}}function toggleRecentActivities(){isShowingAllActivities=!isShowingAllActivities;renderRecentActivities(isShowingAllActivities?allActivities:allActivities.slice(0,2));updateViewAllLink();}function updateViewAllLink(){const viewAllLink=document.getElementById('viewAllActivities');viewAllLink.textContent=isShowingAllActivities?translations.view_less:translations.view_all;}function updateDebtSummary(data){const totalIOwe=data.totalIOwe||0;const totalIAmOwed=data.totalIAmOwed||0;const netPosition=totalIAmOwed-totalIOwe;document.querySelector('#totalIOwe .amount-value').textContent=format_currency(totalIOwe);document.querySelector('#totalIOwe .amount-value').dataset.amount=totalIOwe;document.querySelector('#totalIAmOwed .amount-value').textContent=format_currency(totalIAmOwed);document.querySelector('#totalIAmOwed .amount-value').dataset.amount=totalIAmOwed;const netPositionEl=document.getElementById('netPosition');const netStatusEl=document.getElementById('netStatus');netPositionEl.textContent='₦'+format_currency(Math.abs(netPosition));netPositionEl.dataset.amount=netPosition;if(netPosition>0){netPositionEl.className='net-amount text-success';netStatusEl.textContent=`(${translations.owed_to_you})`;netStatusEl.className='net-status text-success';}else if(netPosition<0){netPositionEl.className='net-amount text-danger';netStatusEl.textContent=`(${translations.you_owe})`;netStatusEl.className='net-status text-danger';}else{netPositionEl.className='net-amount text-muted';netStatusEl.textContent=`(${translations.balanced})`;netStatusEl.className='net-status text-muted';}}function updateCashflowSummary(data){console.log('Updating cashflow summary with:',data);document.getElementById('netCashflow').textContent='₦'+format_currency(data.netCashflow||document.getElementById('netCashflow').dataset.originalAmount);document.getElementById('netCashflow').dataset.originalText='₦'+format_currency(data.netCashflow||document.getElementById('netCashflow').dataset.originalAmount);document.getElementById('totalReceipts').textContent='₦'+format_currency(data.totalReceipts||document.getElementById('totalReceipts').dataset.originalAmount);document.getElementById('totalReceipts').dataset.originalText='₦'+format_currency(data.totalReceipts||document.getElementById('totalReceipts').dataset.originalAmount);document.getElementById('totalPayments').textContent='₦'+format_currency(data.totalPayments||document.getElementById('totalPayments').dataset.originalAmount);document.getElementById('totalPayments').dataset.originalText='₦'+format_currency(data.totalPayments||document.getElementById('totalPayments').dataset.originalAmount);}function getActivityIcon(type){const icons={'debtor_added':'bi-person-plus','creditor_added':'bi-person-plus','forecast_added':'bi-file-earmark-plus','fund_added':'bi-file-earmark-plus','investor_report_added':'bi-file-earmark-plus','feedback_submitted':'bi-star-fill','money_in':'bi-arrow-down-circle','money_out':'bi-arrow-up-circle'};return icons[type]||'bi-circle';}function getActivityColor(type){const colors={'debtor_added':'text-primary','creditor_added':'text-primary','forecast_added':'text-info','fund_added':'text-info','investor_report_added':'text-info','feedback_submitted':'text-warning','money_in':'text-success','money_out':'text-danger'};return colors[type]||'text-muted';}function formatTimeAgo(timestamp){const now=new Date();const time=new Date(timestamp);const diffInSeconds=Math.floor((now-time)/1000);if(diffInSeconds<60)return translations.just_now;if(diffInSeconds<3600)return Math.floor(diffInSeconds/60)+' '+translations.minutes_ago;if(diffInSeconds<86400)return Math.floor(diffInSeconds/3600)+' '+translations.hours_ago;return Math.floor(diffInSeconds/86400)+' '+translations.days_ago;}window.toggleAmountVisibility=function(){amountsVisible=!amountsVisible;const icon=document.getElementById('visibilityIcon');const amounts=document.querySelectorAll('.amount-value,.net-amount,.stat-card-value');amounts.forEach(el=>{if(amountsVisible){if(el.classList.contains('amount-value')){el.textContent=format_currency(el.dataset.amount);}else if(el.classList.contains('net-amount')){el.textContent='₦'+format_currency(Math.abs(el.dataset.amount));}else if(el.classList.contains('stat-card-value')){el.textContent=el.dataset.originalText||el.textContent;}}else{if(!el.dataset.originalText){el.dataset.originalText=el.textContent;}el.textContent='****';}});icon.className='bi '+(amountsVisible?'bi-eye':'bi-eye-slash');};function format_currency(value){if(!value&&value!==0)return '';value=typeof value==="string"?parseFloat(value):value;if(isNaN(value))return '0';return value.toLocaleString('en-NG',{maximumFractionDigits:0});}{%endif%}
