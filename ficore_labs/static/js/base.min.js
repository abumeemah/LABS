function launchConfetti(){const canvas=document.createElement('canvas');canvas.style.position='fixed';canvas.style.top='0';canvas.style.left='0';canvas.style.width='100%';canvas.style.height='100%';canvas.style.pointerEvents='none';canvas.style.zIndex='10000';document.body.appendChild(canvas);const ctx=canvas.getContext('2d');canvas.width=window.innerWidth;canvas.height=window.innerHeight;const particles=[];const colors=['#ff0000','#00ff00','#0000ff','#ffff00','#ff00ff','#00ffff'];function createParticle(){return{x:Math.random()*canvas.width,y:Math.random()*canvas.height,size:Math.random()*5+2,speedX:Math.random()*3-1.5,speedY:Math.random()*3-1.5,color:colors[Math.floor(Math.random()*colors.length)]};}for(let i=0;i<100;i++){particles.push(createParticle());}function animate(){ctx.clearRect(0,0,canvas.width,canvas.height);particles.forEach(p=>{p.x+=p.speedX;p.y+=p.speedY;p.size*=0.98;if(p.size<0.5){const index=particles.indexOf(p);particles.splice(index,1);particles.push(createParticle());}ctx.beginPath();ctx.arc(p.x,p.y,p.size,0,Math.PI*2);ctx.fillStyle=p.color;ctx.fill();});if(particles.length>0){requestAnimationFrame(animate);}else{canvas.remove();}}animate();setTimeout(()=>{particles.length=0;},5000);}function showToast(message,type="info"){const toast=document.createElement("div");toast.className=`toast toast-${type}`;toast.textContent=message;document.body.appendChild(toast);setTimeout(()=>toast.remove(),4000);}window.isAuthenticatedContentBlocked=false;function clearUserData(){localStorage.clear();sessionStorage.clear();console.log('Local user data cleared.');}function handleAuthError(){if(!window.isAuthenticatedContentBlocked){window.isAuthenticatedContentBlocked=true;clearUserData();window.location.href='{{url_for('users.login')|e}}';}}(function(){const originalFetch=window.fetch;window.fetch=async function(...args){if(window.isAuthenticatedContentBlocked){return Promise.reject(new Error('Authenticated content rendering blocked.'));}try{const response=await originalFetch(...args);if(response.status===401||response.status===403){handleAuthError();return Promise.reject(new Error('Unauthorized or Forbidden'));}return response;}catch(error){console.error('Fetch error:',error);throw error;}};})();(function(){const originalOpen=XMLHttpRequest.prototype.open;XMLHttpRequest.prototype.open=function(method,url,...args){if(window.isAuthenticatedContentBlocked){throw new Error('Authenticated content rendering blocked.');}const xhr=this;xhr.addEventListener('load',function(){if(xhr.status===401||xhr.status==403){handleAuthError();}});return originalOpen.call(xhr,method,url,...args);};})();document.addEventListener('DOMContentLoaded',function(){document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(tooltipTriggerEl=>{new bootstrap.Tooltip(tooltipTriggerEl);});document.querySelectorAll('.bi').forEach(icon=>{if(!icon.className.includes('bi-')){console.warn('Invalid or missing Bootstrap Icon class:',icon.className);}});const bottomNav=document.querySelector('.bottom-nav');if(bottomNav){const computedStyle=window.getComputedStyle(bottomNav);if(computedStyle.position!=='fixed'||computedStyle.bottom!=='0px'){console.warn('Bottom navigation positioning issue detected:',{position:computedStyle.position,bottom:computedStyle.bottom});}}const navbarToggler=document.querySelector('.navbar-toggler');const navbarCollapse=document.querySelector('#navbarNav');if(navbarToggler&&navbarCollapse){const collapse=new bootstrap.Collapse(navbarCollapse,{toggle:false});document.querySelectorAll('.navbar-nav .nav-link').forEach(link=>{link.addEventListener('click',()=>{if(navbarCollapse.classList.contains('show')){collapse.hide();navbarToggler.setAttribute('aria-expanded','false');}});});}const storedDarkMode=localStorage.getItem('dark_mode');const isDark=storedDarkMode==='true';if(isDark){document.documentElement.classList.add('dark-mode');const toggles=document.querySelectorAll('#darkModeToggle,#navDarkModeToggle');toggles.forEach(toggle=>{toggle.querySelector('i').className='bi bi-sun';toggle.setAttribute('data-bs-title','{{t("general_mode_toggle_tooltip_switch_to_light",default="Switch to light mode")|e}}');toggle.setAttribute('aria-label','{{t("general_mode_toggle_light",default="Toggle light mode")|e}}');});}{%if current_user.is_authenticated%}if(!window.isAuthenticatedContentBlocked){loadNotificationCount();}{%endif%}const profilePictureInput=document.getElementById('profile_picture');if(profilePictureInput){profilePictureInput.addEventListener('change',function(event){const file=event.target.files[0];if(!file)return;if(!file.type.startsWith('image/')){showToast('{{t("settings_invalid_image",default="Please upload a valid image file.")|e}}','error');return;}if(file.size>5*1024*1024){showToast('{{t("settings_image_too_large",default="Image size must be less than 5MB.")|e}}','error');return;}const formData=new FormData();formData.append('profile_picture',file);formData.append('csrf_token',getCsrfToken());fetch('{{url_for("settings.upload_profile_picture")|e}}',{method:'POST',body:formData}).then(response=>response.json()).then(data=>{if(data.success){document.querySelector('.profile-avatar').src=data.image_url;showToast('{{t("settings_profile_picture_updated",default="Profile picture updated successfully.")|e}}','success');}else{showToast('{{t("settings_failed_to_upload_picture",default="Failed to upload profile picture")|e}}:'+(data.message||'{{t("general_unknown_error",default="Unknown error")|e}}'),'error');}}).catch(error=>{console.error('Error uploading profile picture:',error);showToast('{{t("general_error_occurred",default="An error occurred. Please try again.")|e}}','error');});});}});window.toggleDarkMode=function(){const isDark=!document.documentElement.classList.contains('dark-mode');document.documentElement.classList.toggle('dark-mode',isDark);localStorage.setItem('dark_mode',isDark);const toggles=document.querySelectorAll('#darkModeToggle,#navDarkModeToggle');toggles.forEach(darkModeToggle=>{const icon=darkModeToggle.querySelector('i');icon.className=isDark?'bi bi-sun':'bi bi-moon-stars';icon.style.color=isDark?'#ffc107':'#6c757d';icon.style.transform=isDark?'scale(1.1)':'scale(1)';darkModeToggle.setAttribute('data-bs-title',isDark?'{{t("general_mode_toggle_tooltip_switch_to_light",default="Switch to light mode")|e}}':'{{t("general_mode_toggle_tooltip_switch_to_dark",default="Switch to dark mode")|e}}');darkModeToggle.setAttribute('aria-label',isDark?'{{t("general_mode_toggle_light",default="Toggle light mode")|e}}':'{{t("general_mode_toggle_dark",default="Toggle dark mode")|e}}');const tooltip=bootstrap.Tooltip.getInstance(darkModeToggle);if(tooltip)tooltip.dispose();new bootstrap.Tooltip(darkModeToggle);});};async function toggleLanguage(){if(window.isAuthenticatedContentBlocked)return;const languageTexts=document.querySelectorAll('#languageText,#navLanguageText');if(!languageTexts.length){console.error('Language text element not found.');return;}const currentLang=languageTexts[0].textContent.toLowerCase()==='english'?'en':'ha';const newLang=currentLang==='en'?'ha':'en';const newLangText=newLang==='en'?'ENGLISH':'HAUSA';try{const response=await fetch('{{url_for("set_language",lang="")}}'+newLang,{method:'GET',headers:{'X-CSRFToken':getCsrfToken()}});if(!response.ok)throw new Error('Failed to toggle language');languageTexts.forEach(text=>text.textContent=newLangText);window.location.reload();}catch(error){console.error('Failed to toggle language:',error);}}async function loadNotificationCount(){if(window.isAuthenticatedContentBlocked)return;try{const endpoint='{{url_for("notifications.count")|e}}';if(!endpoint)return;const response=await fetch(endpoint,{headers:{'X-CSRFToken':getCsrfToken()}});if(!response.ok)throw new Error('Network response was not ok');const data=await response.json();const badge=document.getElementById('notificationBadge');if(badge){badge.textContent=data.count||0;badge.className=`notification-badge badge bg-${data.count>0?'danger':'primary'}rounded-circle`;badge.classList.toggle('d-none',data.count===0);}}catch(error){console.error('Failed to load notification count:',error);}}async function loadNotifications(){if(window.isAuthenticatedContentBlocked)return;const body=document.getElementById('notificationBody');if(!body){console.warn('Notification modal body(#notificationBody)not found.');return;}try{const endpoint='{{url_for("notifications.count")|e}}';if(!endpoint){body.innerHTML=`<div class="notification-card"><div class="notification-item"><div class="notification-icon"><i class="bi bi-info-circle text-muted"></i></div><div class="notification-content"><div class="notification-description fw-semibold">{{t('general_no_notifications',default='No notifications')|e}}</div><div class="notification-time text-muted">{{t('general_check_back_later',default='Check back later')|e}}</div></div></div></div>`;return;}const response=await fetch(endpoint,{headers:{'X-CSRFToken':getCsrfToken()}});if(!response.ok)throw new Error('Network response was not ok');const data=await response.json();if(data.error){body.innerHTML=`<p class="text-danger">{{t('general_notification_load_error',default='Failed to load notifications')|e}}</p>`;return;}if(data.length===0){body.innerHTML=`<div class="notification-card"><div class="notification-item"><div class="notification-icon"><i class="bi bi-info-circle text-muted"></i></div><div class="notification-content"><div class="notification-description fw-semibold">{{t('general_no_notifications',default='No notifications')|e}}</div><div class="notification-time text-muted">{{t('general_check_back_later',default='Check back later')|e}}</div></div></div></div>`;}else{body.innerHTML=data.map(notification=>`<div class="notification-card"><div class="notification-item"><div class="notification-icon"><i class="bi ${getNotificationIcon(notification.type)}${notification.read?'text-muted':'text-primary'}"></i></div><div class="notification-content"><div class="notification-description fw-semibold">${notification.message}</div><div class="notification-time text-muted">${formatTimeAgo(notification.timestamp)}</div></div></div></div>`).join('');}}catch(error){body.innerHTML=`<div class="notification-card"><div class="notification-item"><div class="notification-icon"><i class="bi bi-info-circle text-muted"></i></div><div class="notification-content"><div class="notification-description fw-semibold">{{t('general_notification_load_error',default='Failed to load notifications')|e}}</div><div class="notification-time text-muted">{{t('general_check_back_later',default='Check back later')|e}}</div></div></div></div>`;console.error('Failed to load notifications:',error);}}function getCsrfToken(){const token=document.querySelector('meta[name="csrf-token"]')?.content;if(!token){console.error('CSRF token not found in meta tag');}return token||'';}function getNotificationIcon(type){const icons={'email':'bi-envelope','sms':'bi-chat','whatsapp':'bi-whatsapp','info':'bi-info-circle','warning':'bi-exclamation-triangle','error':'bi-x-circle','success':'bi-check-circle'};return icons[type]||'bi-info-circle';}function formatTimeAgo(timestamp){const translations={just_now:'{{t("general_just_now",default="Just now")|e}}',minutes_ago:'{{t("general_minutes_ago",default="m ago")|e}}',hours_ago:'{{t("general_hours_ago",default="h ago")|e}}',days_ago:'{{t("general_days_ago",default="d ago")|e}}',no_notifications:'{{t("no_notifications",default="No notifications")|e}}',check_back_later:'{{t("check_back_later",default="Check back later")|e}}'};const now=new Date();const time=new Date(timestamp);const diffInSeconds=Math.floor((now-time)/1000);if(diffInSeconds<60)return translations.just_now;if(diffInSeconds<3600)return Math.floor(diffInSeconds/60)+' '+translations.minutes_ago;if(diffInSeconds<86400)return Math.floor(diffInSeconds/3600)+' '+translations.hours_ago;return Math.floor(diffInSeconds/86400)+' '+translations.days_ago;}document.getElementById('notificationModal')?.addEventListener('show.bs.modal',loadNotifications);
